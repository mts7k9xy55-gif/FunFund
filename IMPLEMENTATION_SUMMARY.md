# オープン/グループ分離実装サマリー

## 変更ファイル一覧

### 新規作成

1. **`src/app/public/page.tsx`** - オープン一覧ページ（カードグリッド）
2. **`src/app/public/[id]/page.tsx`** - 詳細プレビューページ（Kickstarter風）
3. **`src/app/room/page.tsx`** - グループ（Room）側のページ
4. **`src/components/layer/LayerInputs.tsx`** - 3レイヤー入力コンポーネント
5. **`convex/publicPreviews.ts`** - 公開プレビュー用のquery
6. **`convex/layerInputs.ts`** - 3レイヤー入力用のmutation/query

### 変更

7. **`src/app/page.tsx`** - ルートページをオープン一覧にリダイレクト
8. **`src/components/NewFunFundApp.tsx`** - Room選択時にthreadsを表示、3レイヤー入力を統合
9. **`convex/schema.ts`** - `publicPreviews`と`layerInputs`テーブルを追加

---

## 実装内容

### 1. オープン一覧ページ (`/public`)

- **表示**: サムネイル＋タイトル＋説明のカードグリッド
- **機能**: カードクリックで詳細プレビューへ遷移
- **制約**: 返信/判断/コメント/送信フォームは一切表示しない

### 2. 詳細プレビューページ (`/public/[id]`)

- **上**: サムネ＋タイトル＋短い説明
- **中**: この場で決めること（最大3つ）／向いている人・向いていない人
- **下**: 行動ボタンは1つだけ「グループに入る」
- **制約**: 返信/判断/コメント/送信フォームは一切表示しない

### 3. 「グループに入る」導線

- **未ログイン**: 「グループに入る」押下でログインページへ
- **ログイン済み**: `/room` に遷移（RoomSelectorでRoom選択/作成）
- **Room非アクティブ**: PaywallBanner表示、送信停止（既存実装を流用）

### 4. 3レイヤー入力（グループ内で使用）

- **メモ欄**: 常に表示（自由記述）
- **アンケート**: 広く浅い固定質問（最大5問）
  - 期限はありますか？
  - 予算はありますか？
  - 利害関係はありますか？
  - 決定対象はありますか？
  - 優先度は？
- **インタビュー**: 条件付き表示
  - 条件: 期限あり or 予算あり or 利害強い
  - 質問: 条件に応じた複数の質問（固定テンプレート）
- **保存形式**: JSON文字列として`layerInputs`テーブルに保存

### 5. ルーティング

- `/` → `/public` にリダイレクト（オープン一覧）
- `/public` → オープン一覧ページ
- `/public/[id]` → 詳細プレビューページ
- `/room` → グループ（Room）側のページ（認証必須）

---

## 手動テスト手順（3分）

### 1. オープン一覧の確認

1. アプリ起動: `npm run dev`
2. ブラウザで `http://localhost:3000` にアクセス
3. `/public` にリダイレクトされることを確認
4. カードグリッドが表示されることを確認（データがない場合は空状態）
5. カードをクリックして詳細プレビューへ遷移することを確認

### 2. 詳細プレビューの確認

1. 詳細プレビューページで以下を確認:
   - サムネイル（あれば）
   - タイトル
   - 説明
   - 「この場で決めること」セクション（あれば）
   - 「向いている人・向いていない人」セクション（あれば）
   - 「グループに入る」ボタン
2. 返信/判断/コメント/送信フォームが**表示されない**ことを確認

### 3. 「グループに入る」導線の確認

1. **未ログイン時**:
   - 「グループに入る」ボタンをクリック
   - ログインページに遷移することを確認

2. **ログイン後**:
   - ログイン済みで「グループに入る」をクリック
   - `/room` に遷移することを確認
   - RoomSelectorが表示されることを確認

### 4. 3レイヤー入力の確認

1. `/room` でRoomを選択（または作成）
2. Threadをクリック
3. 3レイヤー入力が表示されることを確認:
   - **メモ欄**: 常に表示
   - **アンケート**: 5つの固定質問が表示
   - **インタビュー**: アンケートで「期限あり」「予算あり」「利害関係あり」のいずれかに回答すると表示
4. 各入力欄に入力して「保存」ボタンをクリック
5. 保存成功メッセージが表示されることを確認
6. ページをリロードして、入力内容が保持されていることを確認

### 5. Room非アクティブ時の動作確認

1. Roomを作成（draft状態）
2. Roomを選択
3. PaywallBannerが表示されることを確認
4. Composerが無効化（disabled）されることを確認
5. 「支払いへ」ボタンが表示されることを確認

---

## データ構造

### `publicPreviews` テーブル

```typescript
{
  itemId: Id<"items">,
  thumbnailUrl?: string,
  description?: string,
  decisions: string[], // 最大3つ
  suitableFor?: string,
  notSuitableFor?: string,
  createdAt: number,
  updatedAt: number,
}
```

### `layerInputs` テーブル

```typescript
{
  roomId: Id<"rooms">,
  threadId: Id<"threads">,
  memo?: string,
  questionnaire?: string, // JSON文字列
  interview?: string, // JSON文字列
  createdBy: Id<"users">,
  createdAt: number,
  updatedAt: number,
}
```

---

## 注意事項

1. **公開プレビュー用データ**: 現在は既存の`items`テーブルから取得していますが、`publicPreviews`テーブルに追加情報を保存することで、より詳細なプレビューを表示できます。

2. **3レイヤー入力のインタビュー**: 現在は固定テンプレートを使用していますが、後でLLM生成に差し替える前提で実装しています。

3. **Room選択時の表示**: Room選択時は`threads`を表示し、既存の`items`ベースの表示は使用しません（後方互換のため、Room未選択時は既存の表示を維持）。

4. **認証**: オープン一覧と詳細プレビューはログイン不要ですが、グループ側（`/room`）は認証必須です。
